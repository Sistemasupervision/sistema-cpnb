<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Inspecciones - CPNB</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        /* ... (todo tu CSS actual) ... */
        /* A√±adimos estilos para los toasts y spinner */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 14px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 9999;
            transform: translateX(200%);
            transition: transform 0.3s ease;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success { background: #38a169; }
        .toast.error { background: #e53e3e; }
        .toast.info { background: #3182ce; }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-loading {
            opacity: 0.8;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- ... (todo tu HTML hasta los botones) ... -->

    <button class="back-btn" onclick="window.location.href='index.html'">‚Üê Volver al Inicio</button>
    <button id="btnExportarHistorial" class="btn-pdf" onclick="exportarHistorialAPDF()" style="margin-bottom: 15px;">
        üìÑ Exportar Historial a PDF
    </button>

    <!-- ... (resto del HTML sin cambios visuales) ... -->

    <!-- Modal de Detalle -->
    <div id="detalleModal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #0c2440; margin: 0;">Detalles de la Inspecci√≥n</h2>
                <div>
                    <button id="btnExportarInspeccion" onclick="exportarInspeccionAPDF()" style="background: #e53e3e; color: white; border: none; border-radius: 6px; padding: 8px 14px; font-size: 14px; margin-right: 10px; cursor: pointer;">
                        üìÑ PDF
                    </button>
                    <span class="close-modal" onclick="cerrarModal()" style="cursor:pointer; font-size: 28px;">&times;</span>
                </div>
            </div>
            <div id="detalleContenido" style="padding: 10px;"></div>
        </div>
    </div>

    <!-- Toast container -->
    <div id="toastContainer"></div>

    <script>
        // === CONSTANTES GLOBALES ===
        const NOMBRES_ITEMS = {
            ba√±o_dama: "Ba√±o Dama",
            ba√±o_caballero: "Ba√±o Caballero",
            dormitorio_femenino: "Dormitorio Femenino",
            dormitorio_masculino: "Dormitorio Masculino",
            cocina: "Cocina",
            comedor: "Comedor",
            lavanderia: "Lavander√≠a",
            oficina_del_jefe: "Oficina del Jefe",
            oficina_de_rrhh: "Oficina de RRHH",
            condiciones_electricas: "Condiciones El√©ctricas",
            fachada: "Fachada",
            condiciones_de_pintura: "Condiciones de Pintura",
            jardines: "Jardines",
            condiciones_generales: "Condiciones Generales",
            vehiculos: "Veh√≠culos",
            motos: "Motos"
        };

        const CCP_NOMBRES = {
            "metropolitano": "CCP METROPOLITANO",
            "sur-del-lago": "CCP SUR DEL LAGO",
            "guajira": "CCP GUAJIRA",
            "col": "CCPE COL"
        };

        const supabaseUrl = 'https://ksczzvtgncvxfrmtvmll.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtzY3p6dnRnbmN2eGZybXR2bWxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3NjMyMzcsImV4cCI6MjA3NDMzOTIzN30.AuWa3uaRylpXhz_VUh097k5tgNHuDllN8j-Hrktwzno';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        // === UTILIDADES ===
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) toast.parentNode.removeChild(toast);
                }, 300);
            }, 3000);
        }

        function setButtonLoading(btnId, loading = true) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            if (loading) {
                btn.classList.add('btn-loading');
                btn.innerHTML = '<span class="spinner"></span> Procesando...';
            } else {
                btn.classList.remove('btn-loading');
                if (btnId === 'btnExportarHistorial') {
                    btn.innerHTML = 'üìÑ Exportar Historial a PDF';
                } else if (btnId === 'btnExportarInspeccion') {
                    btn.innerHTML = 'üìÑ PDF';
                }
            }
        }

        // === RESTO DE TU L√ìGICA (con mejoras) ===
        let inspeccionesCache = [];

        // ... (todo tu c√≥digo de cargarEstaciones, cargarHistorial, etc.) ...

        // Reemplazamos alert() por showToast en cargarHistorial
        document.getElementById('ccpFilter').addEventListener('change', async () => {
            const ccpId = document.getElementById('ccpFilter').value;
            const estacionSelect = document.getElementById('estacionFilter');
            estacionSelect.innerHTML = '<option value="">Todas las estaciones</option>';
            if (!ccpId) return;
            try {
                const { data: estaciones, error } = await supabase
                    .from('estaciones_policiales')
                    .select('id, nombre, ccp_id')
                    .eq('ccp_id', ccpId)
                    .order('nombre', { ascending: true });
                if (error) throw error;
                estaciones.forEach(est => {
                    const opt = document.createElement('option');
                    opt.value = est.id;
                    opt.textContent = est.nombre;
                    estacionSelect.appendChild(opt);
                });
            } catch (error) {
                console.error('Error al cargar estaciones:', error);
                showToast('Error al cargar las estaciones', 'error');
            }
        });

        async function cargarHistorial(fechaDesde = null, fechaHasta = null, ccpId = null, estacionId = null) {
            const contenedor = document.getElementById('inspeccionesList');
            contenedor.innerHTML = '<div class="loading">Cargando historial...</div>';

            try {
                // ... (tu l√≥gica de carga) ...
                // Al final, si hay error:
            } catch (error) {
                console.error('Error al cargar historial:', error);
                contenedor.innerHTML = `<div style="text-align:center; color:red; padding:30px;">Error: ${error.message || 'No se pudo cargar el historial.'}</div>`;
                inspeccionesCache = [];
                showToast('Error al cargar el historial', 'error');
            }
        }

        async function mostrarDetalle(inspeccionId) {
            try {
                // ... (tu l√≥gica) ...
                // Usa NOMBRES_ITEMS en lugar del objeto local
                items.forEach(item => {
                    const nombre = NOMBRES_ITEMS[item.item_nombre] || item.item_nombre;
                    // ...
                });
            } catch (error) {
                console.error('Error al cargar detalles:', error);
                showToast('Error al cargar los detalles', 'error');
            }
        }

        async function exportarInspeccionAPDF() {
            setButtonLoading('btnExportarInspeccion', true);
            try {
                // ... (tu l√≥gica de PDF) ...
            } catch (error) {
                console.error('Error PDF:', error);
                showToast('Error al generar el PDF', 'error');
            } finally {
                setButtonLoading('btnExportarInspeccion', false);
            }
        }

        async function exportarHistorialAPDF() {
            if (inspeccionesCache.length === 0) {
                showToast('No hay inspecciones para exportar', 'info');
                return;
            }
            setButtonLoading('btnExportarHistorial', true);
            try {
                // ... (tu l√≥gica de PDF historial) ...
            } catch (error) {
                console.error('Error PDF historial:', error);
                showToast('Error al generar el PDF del historial', 'error');
            } finally {
                setButtonLoading('btnExportarHistorial', false);
            }
        }

        // Inicializaci√≥n
        const hoy = new Date();
        const hace30Dias = new Date();
        hace30Dias.setDate(hoy.getDate() - 30);
        document.getElementById('fechaHasta').valueAsDate = hoy;
        document.getElementById('fechaDesde').valueAsDate = hace30Dias;

        cargarHistorial(hace30Dias.toISOString().split('T')[0], hoy.toISOString().split('T')[0]);

        // ... (resto de eventos: cerrarModal, aplicarFiltro, etc.) ...
    </script>
</body>
</html>
