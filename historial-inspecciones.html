<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Historial de Inspecciones</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f4f8; }
        .container { max-width: 700px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        select, button { width: 100%; padding: 10px; margin: 10px 0; font-size: 16px; }
        .inspeccion { border-left: 4px solid #3182ce; padding: 10px; margin: 15px 0; background: #f8fafc; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Historial de Inspecciones</h2>

        <select id="ccpSelect">
            <option value="">-- Elija CCP --</option>
            <option value="metropolitano">CCP METROPOLITANO</option>
            <option value="sur-del-lago">CCP SUR DEL LAGO</option>
            <option value="guajira">CCP GUAJIRA</option>
            <option value="col">CCPE COL</option>
        </select>

        <select id="estacionSelect" disabled>
            <option value="">-- Elija CCP primero --</option>
        </select>

        <button id="verBtn" disabled>Ver Historial</button>

        <div id="resultado"></div>
    </div>

    <script>
        const supabase = window.supabase.createClient(
            'https://slkbmddaqsvjofhtuusb.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsa2JtZGRhcXN2am9maHR1dXNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2NTcyNTIsImV4cCI6MjA3NDIzMzI1Mn0.0v7dcDUVXdbLh5bGTwDmLoFjz2ydNFBjiIVAxG6YM6Q'
        );

        const ccpSelect = document.getElementById('ccpSelect');
        const estacionSelect = document.getElementById('estacionSelect');
        const verBtn = document.getElementById('verBtn');
        const resultado = document.getElementById('resultado');

        // Cargar estaciones al cambiar CCP
        ccpSelect.addEventListener('change', async () => {
            const ccp = ccpSelect.value;
            if (!ccp) {
                estacionSelect.disabled = true;
                estacionSelect.innerHTML = '<option value="">-- Elija CCP primero --</option>';
                verBtn.disabled = true;
                return;
            }

            const {  estaciones, error } = await supabase
                .from('estaciones_policiales')
                .select('id, nombre')
                .eq('ccp_id', ccp)
                .order('nombre', { ascending: true });

            if (error) {
                console.error('Error:', error);
                resultado.innerHTML = '<p style="color:red;">Error al cargar estaciones.</p>';
                return;
            }

            let html = '<option value="">-- Seleccione estaci√≥n --</option>';
            estaciones.forEach(e => {
                html += `<option value="${e.id}">${e.nombre}</option>`;
            });
            estacionSelect.innerHTML = html;
            estacionSelect.disabled = false;
        });

        estacionSelect.addEventListener('change', () => {
            verBtn.disabled = !estacionSelect.value;
        });

        // Ver historial
        verBtn.addEventListener('click', async () => {
            const estacionId = estacionSelect.value; // string: "1", "2", etc.
            resultado.innerHTML = '<p>Cargando...</p>';

            const {  inspecciones, error } = await supabase
                .from('inspecciones')
                .select('*')
                .eq('estacion_id', estacionId)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error:', error);
                resultado.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
                return;
            }

            if (!inspecciones || inspecciones.length === 0) {
                resultado.innerHTML = '<p>üîç No hay inspecciones para esta estaci√≥n.</p>';
                return;
            }

            let html = '<h3>Inspecciones encontradas:</h3>';
            inspecciones.forEach(i => {
                const fecha = new Date(i.created_at).toLocaleString('es-VE');
                html += `<div class="inspeccion">
                    <p><strong>Fecha:</strong> ${fecha}</p>
                    <p><strong>Inspector:</strong> ${i.inspector_email}</p>
                    <p><strong>Observaciones:</strong> ${i.observaciones_generales || 'Ninguna'}</p>
                </div>`;
            });

            resultado.innerHTML = html;
        });
    </script>
</body>
</html>
