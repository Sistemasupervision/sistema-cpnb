<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrar Usuarios</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="assets/js/config.js"></script>
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="icon" href=",">
    <style>
        .container { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
        .header { text-align: center; margin-bottom: 2rem; }
        .users-list { margin-top: 1.5rem; }
        .user-card { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1rem; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            margin-bottom: 0.75rem; 
            background: #f9f9f9;
        }
        .user-info { flex: 1; }
        .user-actions { display: flex; gap: 0.5rem; }
        select, button { padding: 0.4rem 0.8rem; border-radius: 4px; border: 1px solid #ccc; }
        button.save-btn { background: #7D0500; color: white; cursor: pointer; }
        button.save-btn:hover { background: #B01B17; }
        #logoutBtn { margin-top: 2rem; background: #6c757d; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; }
        #logoutBtn:hover { background: #5a6268; }
        .loading { text-align: center; margin: 1rem 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë§ Administrar Usuarios</h1>
            <p>Gestiona roles y permisos del sistema</p>
        </div>

        <div id="loading" class="loading">Cargando usuarios...</div>
        <div id="usersContainer" class="users-list" style="display: none;"></div>

        <button id="logoutBtn">Cerrar Sesi√≥n</button>
    </div>

    <script>
        // ‚úÖ Verificar que el usuario sea admin ANTES de mostrar contenido
        async function verificarAccesoAdmin() {
            try {
                const { data } = await supabase.auth.getUser();
                if (!data?.user) {
                    window.location.href = 'index.html'; // Redirigir si no hay sesi√≥n
                    return;
                }

                // Consultar rol
                const {  roles } = await supabase
                    .from('usuarios_roles')
                    .select('rol')
                    .eq('user_id', data.user.id);

                if (!roles?.length || roles[0].rol !== 'admin') {
                    alert('Acceso denegado. Solo los administradores pueden acceder.');
                    window.location.href = 'index.html';
                    return;
                }

                // ‚úÖ Si llega aqu√≠, es admin ‚Üí cargar usuarios
                cargarUsuarios();
            } catch (err) {
                console.error('Error al verificar acceso:', err);
                window.location.href = 'index.html';
            }
        }

        // ‚úÖ Cargar lista de usuarios desde Edge Function
        async function cargarUsuarios() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('usersContainer');

            try {
                const {  session } = await supabase.auth.getSession();
                if (!session) throw new Error('Sesi√≥n no disponible');

                // üîí Llamada a Edge Function segura
                const response = await fetch(
                    'https://' + supabaseUrl.replace('https://', '').replace('/', '') + '/functions/v1/listar-usuarios',
                    {
                        headers: {
                            'Authorization': `Bearer ${session.access_token}`
                        }
                    }
                );

                const result = await response.json();

                if (!response.ok) throw new Error(result.error || 'Error al cargar usuarios');

                // Renderizar lista
                container.innerHTML = result.usuarios.map(u => `
                    <div class="user-card">
                        <div class="user-info">
                            <strong>${u.email}</strong><br>
                            <small>ID: ${u.id}</small>
                        </div>
                        <div class="user-actions">
                            <select id="rol-${u.id}" ${u.id === data.user.id ? 'disabled' : ''}>
                                <option value="consultor" ${u.rol === 'consultor' ? 'selected' : ''}>Consultor</option>
                                <option value="admin" ${u.rol === 'admin' ? 'selected' : ''}>Administrador</option>
                            </select>
                            <button class="save-btn" onclick="guardarRol('${u.id}')"
                                ${u.id === data.user.id ? 'disabled' : ''}>
                                Guardar
                            </button>
                        </div>
                    </div>
                `).join('');

                loading.style.display = 'none';
                container.style.display = 'block';
            } catch (err) {
                console.error('Error:', err);
                loading.textContent = '‚ùå Error al cargar usuarios. Revisa la consola.';
            }
        }

        // ‚úÖ Guardar cambio de rol (llama a Edge Function)
        async function guardarRol(userId) {
            const select = document.getElementById(`rol-${userId}`);
            const nuevoRol = select.value;

            const {  session } = await supabase.auth.getSession();
            const response = await fetch(
                'https://' + supabaseUrl.replace('https://', '').replace('/', '') + '/functions/v1/asignar-rol',
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ user_id: userId, rol: nuevoRol })
                }
            );

            const result = await response.json();
            if (response.ok) {
                alert('‚úÖ Rol actualizado correctamente');
                select.disabled = true;
                setTimeout(() => select.disabled = false, 1000);
            } else {
                alert('‚ùå Error: ' + (result.error || 'No se pudo actualizar'));
            }
        }

        // ‚úÖ Cerrar sesi√≥n
        async function handleLogout() {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        // Iniciar
        verificarAccesoAdmin();
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    </script>
</body>
</html>
