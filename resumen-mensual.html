<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resumen Mensual - CPNB</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #0c2440 0%, #1a365d 50%, #2c5282 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 1000px;
            padding: 40px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, #ffcc00 0%, #ff6b00 50%, #ffcc00 100%);
        }
        .logo-container {
            text-align: center;
            margin-bottom: 25px;
        }
        .logo-img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin: 0 auto 15px;
            display: block;
        }
        .title {
            text-align: center;
            color: #0c2440;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 25px;
        }
        .back-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            cursor: pointer;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            background: linear-gradient(135deg, #2c5282 0%, #1a365d 100%);
            color: white;
        }
        .back-btn:hover {
            opacity: 0.9;
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 14px;
            text-align: center;
            border: 1px solid #e2e8f0;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .kpi-label {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 8px;
        }
        .kpi-value {
            font-size: 28px;
            font-weight: bold;
            color: #0c2440;
        }
        .kpi-value.porcentaje {
            font-size: 24px;
            color: #3182ce;
        }
        .top-list {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 14px;
            margin-bottom: 30px;
            border: 1px solid #bee3f8;
        }
        .top-list h3 {
            color: #0c2440;
            margin-bottom: 15px;
            text-align: center;
        }
        .top-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .top-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            font-weight: bold;
        }
        .chart-container {
            background: #f8fafc;
            padding: 20px;
            border-radius: 14px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
        }
        .chart-wrapper {
            height: 280px;
            position: relative;
        }
        .loading {
            text-align: center;
            color: #666;
            font-size: 18px;
            padding: 30px;
        }
        @media (max-width: 600px) {
            .container {
                padding: 25px;
            }
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            .chart-wrapper {
                height: 220px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <img src="https://raw.githubusercontent.com/Sistemasupervision/sistema-cpnb/main/iamagenes/LOGO-PNB.png" alt="Logo CPNB" class="logo-img">
            <h1 class="title">Resumen Mensual de Inspecciones</h1>
        </div>
        <button class="back-btn" onclick="window.location.href='index.html'">
            ‚Üê Volver al Panel Principal
        </button>
        <div id="loading" class="loading">Cargando resumen mensual...</div>
        <div id="resumenContent" style="display: none;">
            <div class="kpi-grid" id="kpiGrid"></div>
            <div class="top-list">
                <h3>üèÜ Top 3 Estaciones con Mejor Desempe√±o</h3>
                <div class="top-items" id="topEstaciones"></div>
            </div>
            <div class="top-list">
                <h3>‚ö†Ô∏è Top 3 √çtems M√°s Fallados</h3>
                <div class="top-items" id="topItemsFallados"></div>
            </div>
            <div class="chart-container">
                <h3 style="text-align: center; color: #0c2440; margin-bottom: 15px;">Evoluci√≥n Mensual de Cumplimiento</h3>
                <div class="chart-wrapper">
                    <canvas id="evolucionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <script>
        const supabaseUrl = 'https://ksczzvtgncvxfrmtvmll.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtzY3p6dnRnbmN2eGZybXR2bWxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3NjMyMzcsImV4cCI6MjA3NDMzOTIzN30.AuWa3uaRylpXhz_VUh097k5tgNHuDllN8j-Hrktwzno';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        const nombresItems = {
            ba√±o_dama: "Ba√±o Dama",
            ba√±o_caballero: "Ba√±o Caballero",
            dormitorio_femenino: "Dormitorio Femenino",
            dormitorio_masculino: "Dormitorio Masculino",
            cocina: "Cocina",
            comedor: "Comedor",
            lavanderia: "Lavander√≠a",
            oficina_del_jefe: "Oficina del Jefe",
            oficina_de_rrhh: "Oficina de RRHH",
            condiciones_electricas: "Condiciones El√©ctricas",
            fachada: "Fachada",
            condiciones_de_pintura: "Condiciones de Pintura",
            jardines: "Jardines",
            condiciones_generales: "Condiciones Generales",
            vehiculos: "Veh√≠culos",
            motos: "Motos"
        };
        let evolucionChart = null;

        async function cargarResumenMensual() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resumenContent').style.display = 'none';
            try {
                const hoy = new Date();
                const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                const ultimoDiaMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
                const mesActual = hoy.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

                // Fechas formateadas correctamente
                const inicio = primerDiaMes.toISOString().split('T')[0] + 'T00:00:00.000Z';
                const fin = ultimoDiaMes.toISOString().split('T')[0] + 'T23:59:59.999Z';

                // 1. Total de inspecciones este mes
                const { data: inspeccionesMes, error: inspError } = await supabase
                    .from('inspecciones')
                    .select('id, estacion_id')
                    .gte('created_at', inicio)
                    .lte('created_at', fin);
                if (inspError) throw inspError;
                const totalInspecciones = inspeccionesMes.length;

                // 2. % promedio de cumplimiento general
                let cumplimientoGeneral = 0;
                if (totalInspecciones > 0) {
                    const idsInspecciones = inspeccionesMes.map(i => i.id);
                    const { data: items, error: itemsError } = await supabase
                        .from('items_inspeccion')
                        .select('cumple')
                        .in('inspeccion_id', idsInspecciones);
                    if (!itemsError && items.length > 0) {
                        const cumplidos = items.filter(i => i.cumple === true).length;
                        cumplimientoGeneral = Math.round((cumplidos / items.length) * 100);
                    }
                }

                // 3. Top 3 estaciones con mejor desempe√±o
                const topEstaciones = await calcularTopEstaciones(inspeccionesMes);
                const topEstacionesHtml = topEstaciones.map(est => 
                    `<div class="top-item">${est.nombre} <span>${est.porcentaje}%</span></div>`
                ).join('');

                // 4. Top 3 √≠tems m√°s fallados
                const topItemsFallados = await calcularTopItemsFallados(inspeccionesMes);
                const topItemsHtml = topItemsFallados.map(item => 
                    `<div class="top-item">${nombresItems[item.nombre] || item.nombre} <span>${item.fallas} fallas</span></div>`
                ).join('');

                // 5. Evoluci√≥n mensual (√∫ltimos 6 meses)
                const evolucionData = await calcularEvolucionMensual();

                // Renderizar KPIs
                document.getElementById('kpiGrid').innerHTML = `
                    <div class="kpi-card">
                        <div class="kpi-label">Mes Actual</div>
                        <div class="kpi-value">${mesActual}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Total de Inspecciones</div>
                        <div class="kpi-value">${totalInspecciones}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Cumplimiento Promedio</div>
                        <div class="kpi-value porcentaje">${cumplimientoGeneral}%</div>
                    </div>
                `;
                document.getElementById('topEstaciones').innerHTML = topEstacionesHtml || '<div style="text-align:center; color:#666;">No hay datos</div>';
                document.getElementById('topItemsFallados').innerHTML = topItemsHtml || '<div style="text-align:center; color:#666;">No hay datos</div>';
function renderizarEvolucionChart(data) {
    const ctx = document.getElementById('evolucionChart').getContext('2d');
    if (evolucionChart) {
        evolucionChart.destroy();
    }

    const labels = data.map(d => d.mes);
    const valores = data.map(d => d.cumplimiento);

    evolucionChart = new Chart(ctx, {
        type: 'line',
            labels: labels,
            datasets: [{
                label: '% de Cumplimiento',
                 valores,
                borderColor: '#3182ce',
                backgroundColor: 'rgba(49, 130, 206, 0.1)',
                borderWidth: 3,
                pointBackgroundColor: '#0c2440',
                pointRadius: 5,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}
        async function calcularTopEstaciones(inspecciones) {
            if (inspecciones.length === 0) return [];
            const idsInspecciones = inspecciones.map(i => i.id);
            const { data: items, error } = await supabase
                .from('items_inspeccion')
                .select('inspeccion_id, cumple')
                .in('inspeccion_id', idsInspecciones);
            if (error || !items) return [];

            const itemsPorInspeccion = {};
            items.forEach(item => {
                if (!itemsPorInspeccion[item.inspeccion_id]) {
                    itemsPorInspeccion[item.inspeccion_id] = { total: 0, cumplidos: 0 };
                }
                itemsPorInspeccion[item.inspeccion_id].total++;
                if (item.cumple) itemsPorInspeccion[item.inspeccion_id].cumplidos++;
            });

            const estacionesMap = {};
            inspecciones.forEach(insp => {
                const stats = itemsPorInspeccion[insp.id] || { total: 0, cumplidos: 0 };
                const porcentaje = stats.total > 0 ? Math.round((stats.cumplidos / stats.total) * 100) : 0;
                if (!estacionesMap[insp.estacion_id]) {
                    estacionesMap[insp.estacion_id] = { total: 0, suma: 0, count: 0 };
                }
                estacionesMap[insp.estacion_id].suma += porcentaje;
                estacionesMap[insp.estacion_id].count++;
            });

            const idsEstaciones = Object.keys(estacionesMap).map(id => parseInt(id));
            const { data: estacionesData, error: estError } = await supabase
                .from('estaciones_policiales')
                .select('id, nombre')
                .in('id', idsEstaciones);
            if (estError) return [];

            const estacionesConNombre = estacionesData.map(est => ({
                id: est.id,
                nombre: est.nombre,
                porcentaje: Math.round(estacionesMap[est.id].suma / estacionesMap[est.id].count)
            }));

            return estacionesConNombre
                .sort((a, b) => b.porcentaje - a.porcentaje)
                .slice(0, 3);
        }

        async function calcularTopItemsFallados(inspecciones) {
            if (inspecciones.length === 0) return [];
            const idsInspecciones = inspecciones.map(i => i.id);
            const { data: items, error } = await supabase
                .from('items_inspeccion')
                .select('item_nombre, cumple')
                .in('inspeccion_id', idsInspecciones);
            if (error || !items) return [];

            const fallasPorItem = {};
            items.forEach(item => {
                if (!fallasPorItem[item.item_nombre]) {
                    fallasPorItem[item.item_nombre] = 0;
                }
                if (item.cumple === false) {
                    fallasPorItem[item.item_nombre]++;
                }
            });

            return Object.entries(fallasPorItem)
                .map(([nombre, fallas]) => ({ nombre, fallas }))
                .sort((a, b) => b.fallas - a.fallas)
                .slice(0, 3);
        }

        async function calcularEvolucionMensual() {
            const datos = [];
            const hoy = new Date();
            for (let i = 5; i >= 0; i--) {
                const fecha = new Date(hoy.getFullYear(), hoy.getMonth() - i, 1);
                const mes = fecha.toLocaleDateString('es-ES', { month: 'short' });
                const primerDia = new Date(fecha.getFullYear(), fecha.getMonth(), 1);
                const ultimoDia = new Date(fecha.getFullYear(), fecha.getMonth() + 1, 0);

                const inicio = primerDia.toISOString().split('T')[0] + 'T00:00:00.000Z';
                const fin = ultimoDia.toISOString().split('T')[0] + 'T23:59:59.999Z';

                const { data: inspecciones, error } = await supabase
                    .from('inspecciones')
                    .select('id')
                    .gte('created_at', inicio)
                    .lte('created_at', fin);
                if (error || !inspecciones || inspecciones.length === 0) {
                    datos.push({ mes, cumplimiento: 0 });
                    continue;
                }

                const ids = inspecciones.map(i => i.id);
                const { data: items, error: itemsError } = await supabase
                    .from('items_inspeccion')
                    .select('cumple')
                    .in('inspeccion_id', ids);
                if (itemsError || items.length === 0) {
                    datos.push({ mes, cumplimiento: 0 });
                } else {
                    const cumplidos = items.filter(i => i.cumple === true).length;
                    const porcentaje = Math.round((cumplidos / items.length) * 100);
                    datos.push({ mes, cumplimiento: porcentaje });
                }
            }
            return datos;
        }

        function renderizarEvolucionChart(data) {
            const ctx = document.getElementById('evolucionChart').getContext('2d');
            if (evolucionChart) {
                evolucionChart.destroy();
            }

            const labels = data.map(d => d.mes);
            const valores = data.map(d => d.cumplimiento);

            evolucionChart = new Chart(ctx, {
                type: 'line',
                 { // ‚úÖ Correcci√≥n clave: falta ""
                    labels: labels,
                    datasets: [{
                        label: '% de Cumplimiento',
                         valores, // ‚úÖ Correcci√≥n clave: falta ""
                        borderColor: '#3182ce',
                        backgroundColor: 'rgba(49, 130, 206, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#0c2440',
                        pointRadius: 5,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Iniciar carga
        cargarResumenMensual();
    </script>
</body>
</html>
