<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Resumen Mensual - CPNB</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #0c2440 0%, #1a365d 50%, #2c5282 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        .container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.45);
            width: 100%;
            max-width: 1100px;
            padding: 45px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.15);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }
        @keyframes fadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(90deg, #ffcc00, #ff6b00, #ffcc00);
        }
        .logo-container {
            text-align: center;
            margin-bottom: 25px;
        }
        .logo-img {
            width: 110px;
            height: 110px;
            object-fit: contain;
            margin: 0 auto 15px;
            display: block;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
        }
        .title {
            text-align: center;
            color: #0c2440;
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 20px;
            letter-spacing: -0.5px;
        }
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }
        .back-btn {
            background: linear-gradient(135deg, #2c5282, #1a365d);
            color: white;
        }
        .pdf-btn {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 22px;
            margin-bottom: 35px;
            opacity: 0;
            animation: slideIn 0.5s ease 0.2s forwards;
        }
        @keyframes slideIn {
            to { opacity: 1; }
        }
        .kpi-card {
            background: linear-gradient(145deg, #f8fafc, #edf2f7);
            padding: 24px;
            border-radius: 18px;
            text-align: center;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.04);
            transition: transform 0.2s;
        }
        .kpi-card:hover {
            transform: translateY(-3px);
        }
        .kpi-icon {
            font-size: 28px;
            margin-bottom: 12px;
            color: #2c5282;
        }
        .kpi-label {
            font-size: 15px;
            color: #4a5568;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .kpi-value {
            font-size: 30px;
            font-weight: 800;
            color: #0c2440;
        }
        .kpi-value.porcentaje {
            font-size: 26px;
            background: linear-gradient(135deg, #3182ce, #2c5282);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .section-title {
            color: #0c2440;
            font-size: 20px;
            font-weight: 700;
            margin: 25px 0 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            animation: fadeIn 0.5s ease 0.3s forwards;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        .top-list {
            background: #f8fafc;
            padding: 22px;
            border-radius: 18px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.03);
        }
        .top-items {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .top-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 18px;
            background: white;
            border-radius: 12px;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .chart-container {
            background: #f8fafc;
            padding: 25px;
            border-radius: 18px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.03);
        }
        .chart-wrapper {
            height: 320px;
            position: relative;
        }
        .ccp-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .ccp-card {
            background: white;
            border-radius: 14px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            text-align: center;
        }
        .ccp-name {
            font-weight: bold;
            color: #0c2440;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .ccp-cumplimiento {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, #3182ce, #2c5282);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .loading {
            text-align: center;
            color: #4a5568;
            font-size: 19px;
            padding: 40px;
            font-weight: 500;
        }
        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
            }
            .kpi-grid, .ccp-comparison {
                grid-template-columns: 1fr;
            }
            .chart-wrapper {
                height: 260px;
            }
            .title {
                font-size: 24px;
            }
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            .btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="pdf-content">
        <div class="logo-container">
            <img src="https://raw.githubusercontent.com/Sistemasupervision/sistema-cpnb/main/iamagenes/LOGO-PNB.png" alt="Logo CPNB" class="logo-img">
            <h1 class="title">üìä Resumen Mensual de Inspecciones</h1>
        </div>
        <div class="action-buttons">
            <button class="btn back-btn" onclick="window.location.href='index.html'">
                <i class="fas fa-arrow-left"></i> Volver al Panel Principal
            </button>
            <button class="btn pdf-btn" onclick="exportarResumenAPDF()">
                <i class="fas fa-file-pdf"></i> Exportar a PDF
            </button>
        </div>
        <div id="loading" class="loading">Cargando resumen mensual...</div>
        <div id="resumenContent" style="display: none;">
            <div class="kpi-grid" id="kpiGrid"></div>

            <div class="top-list">
                <h3 class="section-title"><i class="fas fa-trophy"></i> üèÜ Top 3 Estaciones con Mejor Desempe√±o</h3>
                <div class="top-items" id="topEstaciones"></div>
            </div>

            <div class="top-list">
                <h3 class="section-title"><i class="fas fa-exclamation-triangle"></i> ‚ö†Ô∏è Top 3 √çtems M√°s Fallados</h3>
                <div class="top-items" id="topItemsFallados"></div>
            </div>

            <div class="chart-container">
                <h3 class="section-title" style="justify-content: center;"><i class="fas fa-chart-line"></i> Evoluci√≥n Mensual de Cumplimiento</h3>
                <div class="chart-wrapper">
                    <canvas id="evolucionChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3 class="section-title" style="justify-content: center;"><i class="fas fa-layer-group"></i> Comparativa por CCP</h3>
                <div class="ccp-comparison" id="ccpComparison"></div>
            </div>
        </div>
    </div>
    <script>
        const supabaseUrl = 'https://ksczzvtgncvxfrmtvmll.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtzY3p6dnRnbmN2eGZybXR2bWxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3NjMyMzcsImV4cCI6MjA3NDMzOTIzN30.AuWa3uaRylpXhz_VUh097k5tgNHuDllN8j-Hrktwzno';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        const nombresItems = {
            ba√±o_dama: "Ba√±o Dama",
            ba√±o_caballero: "Ba√±o Caballero",
            dormitorio_femenino: "Dormitorio Femenino",
            dormitorio_masculino: "Dormitorio Masculino",
            cocina: "Cocina",
            comedor: "Comedor",
            lavanderia: "Lavander√≠a",
            oficina_del_jefe: "Oficina del Jefe",
            oficina_de_rrhh: "Oficina de RRHH",
            condiciones_electricas: "Condiciones El√©ctricas",
            fachada: "Fachada",
            condiciones_de_pintura: "Condiciones de Pintura",
            jardines: "Jardines",
            condiciones_generales: "Condiciones Generales",
            vehiculos: "Veh√≠culos",
            motos: "Motos"
        };
        const ccpNombres = {
            "metropolitano": "CCP METROPOLITANO",
            "sur-del-lago": "CCP SUR DEL LAGO",
            "guajira": "CCP GUAJIRA",
            "col": "CCPE COL"
        };
        let evolucionChart = null;

        async function cargarResumenMensual() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resumenContent').style.display = 'none';
            try {
                const hoy = new Date();
                const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                const ultimoDiaMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
                const mesActual = hoy.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

                // Fechas formateadas correctamente
                const inicio = primerDiaMes.toISOString().split('T')[0] + 'T00:00:00.000Z';
                const fin = ultimoDiaMes.toISOString().split('T')[0] + 'T23:59:59.999Z';

                // 1. Total de inspecciones este mes
                const {  inspeccionesMes, error: inspError } = await supabase
                    .from('inspecciones')
                    .select('id, estacion_id')
                    .gte('created_at', inicio)
                    .lte('created_at', fin);
                if (inspError) throw inspError;
                const totalInspecciones = inspeccionesMes.length;

                // 2. % promedio de cumplimiento general
                let cumplimientoGeneral = 0;
                if (totalInspecciones > 0) {
                    const idsInspecciones = inspeccionesMes.map(i => i.id);
                    const {  items, error: itemsError } = await supabase
                        .from('items_inspeccion')
                        .select('cumple')
                        .in('inspeccion_id', idsInspecciones);
                    if (!itemsError && items.length > 0) {
                        const cumplidos = items.filter(i => i.cumple === true).length;
                        cumplimientoGeneral = Math.round((cumplidos / items.length) * 100);
                    }
                }

                // 3. Top 3 estaciones con mejor desempe√±o
                const topEstaciones = await calcularTopEstaciones(inspeccionesMes);
                const topEstacionesHtml = topEstaciones.map(est => 
                    `<div class="top-item">${est.nombre} <span>${est.porcentaje}%</span></div>`
                ).join('');

                // 4. Top 3 √≠tems m√°s fallados
                const topItemsFallados = await calcularTopItemsFallados(inspeccionesMes);
                const topItemsHtml = topItemsFallados.map(item => 
                    `<div class="top-item">${nombresItems[item.nombre] || item.nombre} <span>${item.fallas} fallas</span></div>`
                ).join('');

                // 5. Evoluci√≥n mensual (√∫ltimos 6 meses)
                const evolucionData = await calcularEvolucionMensual();

                // 6. Comparativa por CCP
                const ccpData = await calcularComparativaCCP(inspeccionesMes);

                // Renderizar KPIs mejorados
                document.getElementById('kpiGrid').innerHTML = `
                    <div class="kpi-card">
                        <div class="kpi-icon">üìÖ</div>
                        <div class="kpi-label">Mes Actual</div>
                        <div class="kpi-value">${mesActual}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon">üìã</div>
                        <div class="kpi-label">Total de Inspecciones</div>
                        <div class="kpi-value">${totalInspecciones}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon">‚úÖ</div>
                        <div class="kpi-label">Cumplimiento Promedio</div>
                        <div class="kpi-value porcentaje">${cumplimientoGeneral}%</div>
                    </div>
                `;
                document.getElementById('topEstaciones').innerHTML = topEstacionesHtml || '<div style="text-align:center; color:#666; padding:15px;">No hay datos suficientes</div>';
                document.getElementById('topItemsFallados').innerHTML = topItemsHtml || '<div style="text-align:center; color:#666; padding:15px;">No hay datos suficientes</div>';

                // Renderizar comparativa CCP
                let ccpHtml = '';
                if (ccpData && ccpData.length > 0) {
                    ccpHtml = ccpData.map(ccp => `
                        <div class="ccp-card">
                            <div class="ccp-name">${ccpNombres[ccp.ccp_id] || ccp.ccp_id}</div>
                            <div class="ccp-cumplimiento">${ccp.porcentaje}%</div>
                        </div>
                    `).join('');
                } else {
                    ccpHtml = '<div style="text-align:center; color:#666; padding:20px;">No hay datos por CCP</div>';
                }
                document.getElementById('ccpComparison').innerHTML = ccpHtml;

                // Renderizar gr√°fico
                renderizarEvolucionChart(evolucionData);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('resumenContent').style.display = 'block';
            } catch (error) {
                console.error('Error al cargar resumen:', error);
                document.getElementById('loading').textContent = '‚ö†Ô∏è Error al cargar los datos. Verifique la consola.';
                document.getElementById('loading').style.display = 'block';
            }
        }

        async function calcularTopEstaciones(inspecciones) {
            if (inspecciones.length === 0) return [];
            const idsInspecciones = inspecciones.map(i => i.id);
            const { data: items, error } = await supabase
                .from('items_inspeccion')
                .select('inspeccion_id, cumple')
                .in('inspeccion_id', idsInspecciones);
            if (error || !items) return [];

            const itemsPorInspeccion = {};
            items.forEach(item => {
                if (!itemsPorInspeccion[item.inspeccion_id]) {
                    itemsPorInspeccion[item.inspeccion_id] = { total: 0, cumplidos: 0 };
                }
                itemsPorInspeccion[item.inspeccion_id].total++;
                if (item.cumple) itemsPorInspeccion[item.inspeccion_id].cumplidos++;
            });

            const estacionesMap = {};
            inspecciones.forEach(insp => {
                const stats = itemsPorInspeccion[insp.id] || { total: 0, cumplidos: 0 };
                const porcentaje = stats.total > 0 ? Math.round((stats.cumplidos / stats.total) * 100) : 0;
                if (!estacionesMap[insp.estacion_id]) {
                    estacionesMap[insp.estacion_id] = { total: 0, suma: 0, count: 0 };
                }
                estacionesMap[insp.estacion_id].suma += porcentaje;
                estacionesMap[insp.estacion_id].count++;
            });

            const idsEstaciones = Object.keys(estacionesMap).map(id => parseInt(id));
            const {  estacionesData, error: estError } = await supabase
                .from('estaciones_policiales')
                .select('id, nombre')
                .in('id', idsEstaciones);
            if (estError) return [];

            const estacionesConNombre = estacionesData.map(est => ({
                id: est.id,
                nombre: est.nombre,
                porcentaje: Math.round(estacionesMap[est.id].suma / estacionesMap[est.id].count)
            }));

            return estacionesConNombre
                .sort((a, b) => b.porcentaje - a.porcentaje)
                .slice(0, 3);
        }

        async function calcularTopItemsFallados(inspecciones) {
            if (inspecciones.length === 0) return [];
            const idsInspecciones = inspecciones.map(i => i.id);
            const {  items, error } = await supabase
                .from('items_inspeccion')
                .select('item_nombre, cumple')
                .in('inspeccion_id', idsInspecciones);
            if (error || !items) return [];

            const fallasPorItem = {};
            items.forEach(item => {
                if (!fallasPorItem[item.item_nombre]) {
                    fallasPorItem[item.item_nombre] = 0;
                }
                if (item.cumple === false) {
                    fallasPorItem[item.item_nombre]++;
                }
            });

            return Object.entries(fallasPorItem)
                .map(([nombre, fallas]) => ({ nombre, fallas }))
                .sort((a, b) => b.fallas - a.fallas)
                .slice(0, 3);
        }

        async function calcularEvolucionMensual() {
            const datos = [];
            const hoy = new Date();
            for (let i = 5; i >= 0; i--) {
                const fecha = new Date(hoy.getFullYear(), hoy.getMonth() - i, 1);
                const mes = fecha.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' });
                const primerDia = new Date(fecha.getFullYear(), fecha.getMonth(), 1);
                const ultimoDia = new Date(fecha.getFullYear(), fecha.getMonth() + 1, 0);

                const inicio = primerDia.toISOString().split('T')[0] + 'T00:00:00.000Z';
                const fin = ultimoDia.toISOString().split('T')[0] + 'T23:59:59.999Z';

                const {  inspecciones, error } = await supabase
                    .from('inspecciones')
                    .select('id')
                    .gte('created_at', inicio)
                    .lte('created_at', fin);
                if (error || !inspecciones || inspecciones.length === 0) {
                    datos.push({ mes, cumplimiento: 0 });
                    continue;
                }

                const ids = inspecciones.map(i => i.id);
                const { data: items, error: itemsError } = await supabase
                    .from('items_inspeccion')
                    .select('cumple')
                    .in('inspeccion_id', ids);
                if (itemsError || !items || items.length === 0) {
                    datos.push({ mes, cumplimiento: 0 });
                } else {
                    const cumplidos = items.filter(i => i.cumple === true).length;
                    const porcentaje = Math.round((cumplidos / items.length) * 100);
                    datos.push({ mes, cumplimiento: porcentaje });
                }
            }
            return datos;
        }

        async function calcularComparativaCCP(inspecciones) {
            if (inspecciones.length === 0) return [];
            
            // Obtener estaciones con sus CCP
            const idsEstaciones = [...new Set(inspecciones.map(i => i.estacion_id))];
            const {  estaciones, error: estError } = await supabase
                .from('estaciones_policiales')
                .select('id, ccp_id')
                .in('id', idsEstaciones);
            if (estError) return [];

            const estacionCCPMap = {};
            estaciones.forEach(est => {
                estacionCCPMap[est.id] = est.ccp_id;
            });

            // Agrupar inspecciones por CCP
            const ccpInspecciones = {};
            inspecciones.forEach(insp => {
                const ccp = estacionCCPMap[insp.estacion_id];
                if (ccp) {
                    if (!ccpInspecciones[ccp]) ccpInspecciones[ccp] = [];
                    ccpInspecciones[ccp].push(insp.id);
                }
            });

            // Calcular cumplimiento por CCP
            const resultados = [];
            for (const [ccpId, ids] of Object.entries(ccpInspecciones)) {
                const {  items, error } = await supabase
                    .from('items_inspeccion')
                    .select('cumple')
                    .in('inspeccion_id', ids);
                if (!error && items && items.length > 0) {
                    const cumplidos = items.filter(i => i.cumple === true).length;
                    const porcentaje = Math.round((cumplidos / items.length) * 100);
                    resultados.push({ ccp_id: ccpId, porcentaje });
                }
            }

            return resultados.sort((a, b) => b.porcentaje - a.porcentaje);
        }

      function renderizarEvolucionChart(data) {
    const ctx = document.getElementById('evolucionChart').getContext('2d');
    if (evolucionChart) {
        evolucionChart.destroy();
    }

    const labels = data.map(d => d.mes);
    const valores = data.map(d => d.cumplimiento);

    evolucionChart = new Chart(ctx, {
        type: 'line',
         {  // <-- Aqu√≠ estaba el error: faltaba "data:"
            labels: labels,
            datasets: [{
                label: '% de Cumplimiento',
                 valores,  // <-- Aqu√≠ estaba el error: faltaba "data:"
                borderColor: '#2c5282',
                backgroundColor: 'rgba(44, 82, 130, 0.12)',
                borderWidth: 4,
                pointBackgroundColor: '#0c2440',
                pointRadius: 6,
                pointHoverRadius: 8,
                tension: 0.4,
                fill: true,
                cubicInterpolationMode: 'monotone'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 13, weight: 'bold' },
                        color: '#2d3748'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(12, 36, 64, 0.9)',
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    padding: 12,
                    displayColors: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        },
                        font: { size: 12 }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 12, weight: 'bold' }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}
        async function exportarResumenAPDF() {
            const content = document.getElementById('pdf-content');
            if (!content) {
                alert('No se puede exportar: contenido no encontrado.');
                return;
            }

            try {
                const printDiv = document.createElement('div');
                printDiv.innerHTML = `
                    <div style="font-family: Segoe UI, Arial, sans-serif; padding: 30px; max-width: 800px;">
                        <div style="text-align: center; margin-bottom: 25px;">
                            <img src="https://raw.githubusercontent.com/Sistemasupervision/sistema-cpnb/main/iamagenes/LOGO-PNB.png" 
                                 alt="Logo CPNB" style="width: 100px; height: 100px; object-fit: contain;">
                            <h1 style="color: #0c2440; margin-top: 15px; font-size: 24px; font-weight: 800;">
                                RESUMEN MENSUAL DE INSPECCIONES
                            </h1>
                            <p style="color: #4a5568; font-size: 14px;">Cuerpo de Polic√≠a Nacional Bolivariana</p>
                        </div>
                        ${document.getElementById('kpiGrid').outerHTML}
                        ${document.getElementById('topEstaciones').closest('.top-list').outerHTML}
                        ${document.getElementById('topItemsFallados').closest('.top-list').outerHTML}
                        <div style="margin-top: 25px; padding: 20px; background: #f8fafc; border-radius: 12px;">
                            <h3 style="text-align: center; color: #0c2440; margin-bottom: 15px; font-weight: 700;">
                                Comparativa por CCP
                            </h3>
                            ${document.getElementById('ccpComparison').outerHTML}
                        </div>
                        <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
                            Fecha de generaci√≥n: ${new Date().toLocaleString('es-ES')}
                        </div>
                    </div>
                `;
                document.body.appendChild(printDiv);
                printDiv.style.position = 'fixed';
                printDiv.style.left = '-9999px';
                printDiv.style.width = '800px';

                const canvas = await html2canvas(printDiv, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                });

                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(`resumen_mensual_cpnb_${new Date().toISOString().slice(0, 10)}.pdf`);
                document.body.removeChild(printDiv);
            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('Error al generar el PDF. Intente nuevamente.');
            }
        }

        // Iniciar carga
        cargarResumenMensual();
    </script>
</body>
</html>
