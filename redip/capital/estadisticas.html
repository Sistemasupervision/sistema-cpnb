<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas - REDIP CAPITAL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #0c2440 0%, #1a365d 50%, #2c5282 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 950px;
            padding: 40px;
            position: relative;
            overflow: hidden;
            z-index: 10;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, #ffcc00 0%, #ff6b00 50%, #ffcc00 100%);
        }
        .logo-container {
            text-align: center;
            margin-bottom: 25px;
        }
        .logo-img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin: 0 auto 15px;
            display: block;
        }
        .title {
            text-align: center;
            color: #0c2440;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 25px;
        }
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .back-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            background: linear-gradient(135deg, #2c5282 0%, #1a365d 100%);
            color: white;
        }
        .back-btn:hover {
            opacity: 0.9;
        }
        .filtro-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        .input-group {
            flex: 1;
            min-width: 300px;
        }
        .input-group label {
            font-size: 14px;
            color: #2d3748;
            margin-bottom: 8px;
            display: block;
            font-weight: 600;
        }
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #cbd5e0;
            border-radius: 10px;
            font-size: 15px;
            background-color: white;
            font-weight: 500;
        }
        .loading, .no-data {
            text-align: center;
            color: #666;
            font-size: 18px;
            padding: 30px;
            background: #f8fafc;
            border-radius: 12px;
            margin: 20px 0;
        }
        .stats-header {
            text-align: center;
            margin: 20px 0;
            font-size: 20px;
            color: #0c2440;
            font-weight: bold;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 12px;
            border: 1px solid #bee3f8;
        }
        .chart-container {
            margin: 25px 0;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            max-height: 400px;
            overflow-y: auto;
        }
        .chart-wrapper {
            height: 600px;
            position: relative;
            min-width: 800px;
        }
        .porcentajes-container {
            margin-top: 25px;
        }
        .tabla-filtro input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 14px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background: #edf2f7;
            font-weight: bold;
            color: #2d3748;
        }
        tr:hover {
            background: #f8fafc;
        }
        .porcentaje-valor {
            font-weight: bold;
            text-align: center;
        }
        .porcentaje-valor.bajo { color: #e53e3e; }
        .porcentaje-valor.medio { color: #dd6b20; }
        .porcentaje-valor.alto { color: #38a169; }
        .pagination-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .pagination-controls button {
            padding: 8px 16px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <img src="../../assets/img/LOGO-PNB.png" alt="Logo CPNB" class="logo-img">
            <h1 class="title">Estadísticas - REDIP CAPITAL</h1>
        </div>
        <button class="back-btn" onclick="window.location.href='index.html'" style="margin-bottom: 20px;">
            ← Volver al Panel Principal
        </button>
        <div class="filtro-container">
            <div class="input-group">
                <label for="estacionFilter">Seleccione una Estación de la REDIP CAPITAL:</label>
                <select id="estacionFilter">
                    <option value="">-- Cargando estaciones... --</option>
                </select>
            </div>
        </div>
        <div id="resultadosContainer" style="display: none;">
            <div class="stats-header" id="statsHeader"></div>
            <div class="action-buttons">
                <button class="back-btn" onclick="volverASeleccion()">
                    ← Seleccionar otra estación
                </button>
            </div>
            <div class="chart-container">
                <div class="chart-wrapper">
                    <canvas id="cumplimientoChart"></canvas>
                </div>
            </div>
            <div class="porcentajes-container">
                <div class="tabla-filtro">
                    <input type="text" id="filtroItems" placeholder="Buscar ítem...">
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Ítem</th>
                            <th style="text-align: center;">%</th>
                        </tr>
                    </thead>
                    <tbody id="tablaItems"></tbody>
                </table>
                <div class="pagination-controls">
                    <button id="btnAnterior" class="back-btn" disabled>« Anterior</button>
                    <span id="paginaActual" style="align-self: center; font-weight: bold; color: #2d3748;">Página 1</span>
                    <button id="btnSiguiente" class="back-btn" disabled>Siguiente »</button>
                </div>
            </div>
        </div>
        <div id="mensajeCarga" class="loading" style="display: none;">Cargando estadísticas...</div>
        <div id="mensajeSinDatos" class="no-data" style="display: none;">
            <div style="text-align: center; padding: 20px;">
                <p>No existen inspecciones para esta estación.</p>
                <button onclick="volverASeleccion()" 
                        style="background: linear-gradient(135deg, #2c5282 0%, #1a365d 100%); color: white; border: none; border-radius: 8px; padding: 8px 16px; font-size: 14px; margin-top: 10px; cursor: pointer;">
                    ← Volver a Selección
                </button>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://ksczzvtgncvxfrmtvmll.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtzY3p6dnRnbmN2eGZybXR2bWxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3NjMyMzcsImV4cCI6MjA3NDMzOTIzN30.AuWa3uaRylpXhz_VUh097k5tgNHuDllN8j-Hrktwzno';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        const nombresItems = {
            nombramiento_comandante: "1. Verificar el nombramiento como comandante del CCP.",
            acta_entrega_recepcion: "2. Revisar acta de entrega y recepción del ccp. Verifique los asuntos pendientes y las acciones tomadas para la solución o tramitación. Resultados obtenidos las acciones tomadas",
            dossier_comandante: "3. verificar que el comandante de la unidad posea el dossier contentivo de los siguientes documentos de la unidad: punto de cuenta o resolución de creación y activación, exposición de motivos para la creación y activación, justificación actual de su funcionamiento, documentos de propiedad o comodato del terreno e instalaciones, ficha catastral.",
            conocimiento_ley_organica: "4. Verificar en físico y el conocimiento sobre la ley orgánica del servicio de policía, ley del cuerpo de Policía Nacional Bolivariana",
            conocimiento_estatuto_personal: "5. Verificar en físico y el conocimiento sobre el reglamento sobre el estatuto de la función policial en materia de administración de personal y desarrollo de la carrera policial",
            conocimiento_reglamento_disciplinario: "6. Verificar en físico y el conocimiento sobre el reglamento de la función policial sobre el régimen disciplinario",
            estructura_organizativa: "7. Verificar el conocimiento de la estructura organizativa del CPNB y la aplicación de la estructura funcional del CCP.",
            manuales_normas_procedimientos: "8. Verificar los manuales de normas y procedimientos operativos vigentes, actualizado.",
            plan_trabajo_anual: "9. Verificar el plan de trabajo anual, cumplimiento y logros.",
            infraestructura_identificacion: "10. Verificar que las infraestructuras físicas cumplan con la adecuada identificación establecidas por la institución, incluyendo los servicios ubicados fuera de las instalaciones del CCP.",
            direccion_atencion_victima: "11. Verificación de la activación de la brigada policial especial de protección y asistencia a las víctimas testigos y demás sujetos procesales",
            oficina_gestion_humana: "12. Verificar con la oficina de gestión humana cpnb: relación del personal, plan anual de vacaciones, plan vacacional, reposos, ascensos, tramitaciones de bajas, planes de entrenamiento y reentrenamiento tramitaciones de comisión de servicio",
            documentacion_personal: "13. Constatar en el personal policial, la existencia de la documentación (se hará con muestra representativa). Carnet único policial, cédula de identidad, licencia de conducir y certificado médico, declaración de impuesto sobre la renta y jurada de patrimonio, carnet de la patria, porte de armas. si aplica, inscripción en la correspondiente caja de ahorros.",
            uniforme_presentacion: "14. Constatar el uso correcto del uniforme y presentación personal: corte de cabello, rasurado, uniforme limpio, botas pulidas, cabello recogido, uñas cortas (caso femenino uñas y maquillaje colores claros)",
            practica_induccion_orden_publico: "15. Verificar que la unidad posea y haya realizado práctica de los planes de reacción inmediata, defensa y de evacuación.",
            entrenamiento_armamento: "16. Verificar si los funcionarios reciben entrenamiento en el manejo de armamento orgánico.",
            talleres_manejo_defensivo: "17. Verificar la realización de talleres de manejo defensivo y de servicio de seguridad vial a los conductores de unidades tipo moto y vehículos.",
            conocimientos_primeros_auxilios: "18. Verificar si los efectivos poseen los conocimientos mínimos necesarios de primeros auxilios.",
            acciones_moral_disciplina: "19. Verificar las acciones tomadas por el coordinador o coordinadora del ccp para elevar la moral, mantener la disciplina, espíritu de cuerpo, bienestar y salud del personal.",
            conocimiento_pensamiento_bolivariano: "20. Verificar el conocimiento del pensamiento bolivariano sobre el legado del libertador Simón Bolívar y el comandante supremo Hugo Chávez al personal policial.",
            instruccion_etica_moral: "21. Verificar si constantemente se instruye al personal sobre honestidad, ética, moralidad y espíritu de cuerpo, revisar registros en el libro de charlas y servicio de día.",
            talleres_ministerio_publico: "22. Verificar talleres dictados al personal por parte de autoridades del ministerio público, judiciales y consultor jurídico, sobre procedimientos y cumplimiento del debido proceso, derechos humanos y derecho internacional humanitario.",
            conocimiento_lineamientos_cpnb: "23. Constatar el conocimiento del coordinador o coordinadora del ccp en relación a los lineamientos para ejercer el control de normas, ordenes, procedimientos e instrucciones impartidas por la directiva del CPNB ¿qué acciones ha realizado para su difusión e implementación?",
            cursos_sustanciacion_expedientes: "24. Constatar la realización de cursos de sustanciación de expedientes administrativos, actas policiales y pericias judiciales para el personal de la unidad.",
            cumplimiento_entrenamiento_fisico: "25. Verificar el cumplimiento del entrenamiento en cuanto: educación física, orden público",
            dotacion_trajes_antimotines: "26. Verificar si la dotación de los trajes antimotines es suficiente para la capacidad operativa del CCP.",
            practica_tecnicas_policiales: "27. Verificar si el personal ha realizado práctica de: tiro de combate con escopeta, tiro de combate y policial con pistola 9mm, mantenimiento y preservación del armamento, mantenimiento, control y restablecimiento del orden público, uso progresivo y diferenciado de la fuerza, defensa personal, orden cerrado, combate en áreas confinadas, instalación de puntos de control (DIRECTIVA MPPRIJP-MPPD), inspección de personas, y revisión de vehículos, embarcaciones y aeronaves.",
            numero_funcionarios_suficiente: "28. Constatar que el número de funcionarios adscrito a la unidad, sea suficiente para cumplir con los servicios policiales.",
            personal_empleado_servicios: "29. Verificar que el personal policial del CCP inspeccionado, este siendo empleado para cumplir con los servicios de policiales.",
            servicios_autorizados_mpprijp: "30. Verificar que los únicos servicios a ser prestados por parte de los efectivos del cuerpo de Policía Nacional Bolivariana fuera de la unidad serán aquellos autorizados por el ministro o ministra del poder popular las relaciones interiores justicia y paz y el comando general del Cuerpo de Policía Nacional Bolivariana a través del; por lo tanto ninguna autoridad civil ni militar podrá solicitar este tipo de apoyos sin ser canalizados a través de las instancias antes mencionadas. en caso de estar autorizados, deberán tomar las acciones para que en aquellos lugares aislados, prever los relevos durante la noche, comunicación por cualquier medio (teléfono o radio), verificando su situación cada hora en horario nocturno y cada 4 horas en horario diurno, así como también patrullajes constantes si la zona donde se presta el servicio de alta peligrosidad.",
            publicaciones_procedimientos: "31. Verificar los siguientes aspectos en las publicaciones de los procedimientos: el backing institucional de la Policía Nacional Bolivariana en todas las unidades operativas, uso obligatorio de mesa o mesones según sea el caso, con mantel, para los elementos retenidos de poco tamaño, realizar las fotos en alta definición, realizar las fotos por separado de acuerdo al tamaño de los efectos retenidos según sea el caso y prohibido que aparezcan efectivos policiales en la fotos de los procedimientos realizados,",
            libros_novedades: "32. Verificar en los libros de novedades: la realización diaria de la izada y arreada de la bandera de venezuela en los ccp, estaciones policiales, la información impartida en las formaciones diarias con los funcionarios, el cumplimiento de las instrucciones sobre el mínimo personal requerido por comisión debe ser de seis (06) hombres, con un oficial jefe como jerarquía mínima (boleta de comisión), al mando, constatar que el personal policial tenga conocimiento que esta prohibido las persecuciones, salvo excepciones en casos de emergencias, y deberá estar bajo el criterio y conocimiento del jefe o jefa de la unidad, que el personal policial tome las medidas de seguridad durante el desempeño del servicio y/o comisión (uso de chaleco anti balas, armamento, pito y linterna).",
            libro_actas_reuniones: "33. Verificar en el libro de reuniones las actas de reuniones de coordinación con los entes gubernamentales o empresas privadas.",
            libro_reuniones_personal: "34. Verificar el libro de reuniones con el personal policial y civil adscrito al ccp, con las planificaciones semanales realizadas por el jefe de cada servicios del CCP.",
            archivo_general_expedientes: "35. Verificación del archivo general.",
            libro_entrevistas_funcionarios: "36. verificar el libro de entrevistas del coordinador o coordinadora del ccp con los funcionarios de su jurisdicción.",
            supervision_libros: "37. verifica regularmente las anotaciones en los siguientes libros: Entrada y salida de armamento, inspección y jefe de los servicios, ordenes de carácter permanente y libro de ronda.",
            cumplimiento_normativa_instalaciones: "38. Verificar el cumplimiento de la normativa para: parque de armas, sala de evidencias.",
            bienes_publicos_registrados: "39. Verificación que los bienes públicos existentes estén de acuerdo con los registrados en la oficina de gestión administrativa CPNB.",
            resguardo_detenido: "40. verificar las condiciones con respecto al resguardo del detenido: seguridad de las instalaciones, medidas de control, condiciones de los funcionarios, condiciones de los privados de libertad y cumplimiento de las normativas para el traslado de los privados de libertad.",
            equipos_control_incendios: "41. Verificar la existencia y operatividad de equipos de control de incendios, tales como extintores, cajón de arena, entre otros.",
            equipos_comunicacion: "42. Verificar la cantidad de equipos de comunicación pertenecientes al ccp y las condición de los mismos",
            plan_hospedaje_personal: "43. Verificar que el coordinador o coordinadora del ccp. tenga previsto un plan de hospedaje para el personal de apoyo y reemplazos.",
            calidad_vida_personal: "44. Verificar la calidad de vida, alimentación, servicios básicos, habitabilidad, confort y bienestar del personal policial de la unidad inspeccionada.",
            plan_visita_estaciones: "45. Verificar el plan de visita de inspección de todas las estaciones policiales de la jurisdicción del ccp inspeccionado. (verificar si las instalaciones policiales ubicados en lugares aislados o en arterias viales distantes ofrecen las condiciones de seguridad, correspondientes)",
            servicio_medico: "46. Verificar si existe una enfermería en el CCP.",
            unidad_recepcion_denuncias: "47. verificar la existencia de la unidad recepción de denuncias, quejas y reclamos recibidos en coordinación con los tribunales, fiscalía del ministerio público, defensoría del pueblo a nivel estadal y municipal y la comunidad",
            areas_esparcimiento: "48. Verificar las instalaciones de las áreas de esparcimiento tales como comedores y dormitorios (televisores, muebles, mesas sillas)",
            vehiculos_operativos: "49. Constatar la cantidad de vehículos operativos, inoperativos y el plan de mantenimiento existente del ccp inspeccionada. ¿que acciones de comando se han tomado en relación a estos vehículos siniestrados?",
            placa_policial_vehiculos: "50. Verificar que todos los vehículos pertenecientes al parque automotor tenga placa policial",
            vehiculos_suficientes: "51. Verificar si la cantidad de vehículos operativos son suficientes para el desempeño de los servicios de policiales.",
            vehiculos_donados_inventario: "52. Verificar si el ccp ha recibido vehículos donados o en comodato y si se han incluidos en el inventario nacional del CPNB.",
            accesorios_seguridad_vehiculos: "53. Verificar los accesorios de seguridad que debe llevar todo vehículos.",
            necesidades_repuestos_vehiculos: "54. Constatar las necesidades o requerimientos de repuestos, cauchos y accesorios de vehículos de la unidad inspeccionada.",
            identificacion_vehiculos_policiales: "55. Verificar que los vehículos policiales estén plenamente identificados con los logos policiales correspondientes, cautelera y equipo P.A operativo",
            informes_parques_armas: "56. Verificar los informes de inspecciones realizadas a los parques de armas por la oficina de gestión administrativa cpnb y elaborar un acta de inspección con los resultados.",
            supervision_pac: "57. Verificar las acciones de comando establecidas en la supervisión y control de los puntos de atención al ciudadano (p.a.c). (permitan el normal flujo de los productos de primera necesidad (comida y medicamentos) que forman parte del sistema nacional de abastecimiento del gobierno bolivariano)",
            vademecum_actualizado: "58. Verificar y revisar el vademecum general del ccp, debidamente actualizado por las estaciones policiales.",
            despliegues_policiales: "59. Supervisar el cumplimiento de los despliegues policiales emanados por la oficina de operaciones policiales y las actividades extraordinarias realizadas por el CCP.",
            supervision_personal_mando: "60. Constatar si hay mayor nivel de supervisión y control sobre el personal, para cumplir en todo momento el principio de mando y conducción de mantener informado a tu personal, sobre la situación actual.",
            planes_contra_trafico_ilicito: "61. Verificar los planes para contrarrestar el tráfico ilícito, distribución y comercialización de sustancias estupefacientes y psicotrópicas, alimentos de la cesta básica, materiales estratégicos, hidrocarburos, armamento y delitos comunes.",
            conocimiento_lineamientos_derechos_humanos: "62. Constatar que el personal policial tenga conocimiento de los lineamientos de instrucción en materia de: derechos humanos, derecho internacional humanitario: armas letales, orden público, unidades tácticas policiales y los procedimiento con niños, niñas y adolescentes, igualdad y equidad de género.",
            registro_actuaciones_cop: "63. Verificar el registro y control de las actuaciones positivas y negativas al personal en el centro de operaciones policiales (COP) del ccp, por cuadrante de paz.",
            rendicion_procedimientos_cop: "64. Verificar el cumplimiento de la rendición de los procedimiento ejecutados por los servicios policiales al centro de operación policial (cop) del ccp, para su consolidación y rendición a la región de su subscripción.",
            archivos_informes_rendicion: "65. Revisión de los archivos de los informes de rendición de cuenta de los procedimientos policiales.",
            informes_preliminares_actuacion: "66. Verificar la elaboración de los informes preliminares de actuación policial.",
            estatus_procesos_administrativos: "67. Verificar el estatus de los procesos administrativos ante la ICAP del personal a su mando."
        };

        const todosLosItems = Object.keys(nombresItems);
        const ITEMS_POR_PAGINA = 15;
        let chartInstance = null;
        let estadisticasTotales = {};
        let nombreEstacionActual = '';
        let paginaActual = 1;
        let totalPaginas = 1;

        // === Cargar automáticamente estaciones de REDIP CAPITAL (ccp_distrito_capital) ===
        async function cargarEstacionesCapital() {
            const select = document.getElementById('estacionFilter');
            try {
                const { data: estaciones, error } = await supabase
                    .from('estaciones_policiales')
                    .select('estacion_id, nombre_estacion')
                    .eq('ccp_id', 'ccp_distrito_capital') // ✅ CORREGIDO
                    .order('nombre_estacion', { ascending: true });
                if (error) throw error;
                select.innerHTML = '<option value="">-- Seleccione una estación --</option>';
                if (estaciones && estaciones.length > 0) {
                    estaciones.forEach(est => {
                        const opt = document.createElement('option');
                        opt.value = est.estacion_id;
                        opt.textContent = est.nombre_estacion;
                        select.appendChild(opt);
                    });
                } else {
                    select.innerHTML = '<option value="">No hay estaciones en REDIP CAPITAL</option>';
                }
            } catch (err) {
                console.error('Error al cargar estaciones:', err);
                select.innerHTML = '<option value="">Error al cargar</option>';
            }
        }

        document.getElementById('estacionFilter').addEventListener('change', (e) => {
            const estacionId = e.target.value;
            if (estacionId) {
                cargarEstadisticas(estacionId);
            }
        });

        async function cargarEstadisticas(estacionId) {
            const estacionNombre = document.querySelector(`#estacionFilter option[value="${estacionId}"]`).textContent;
            nombreEstacionActual = estacionNombre;
            document.getElementById('resultadosContainer').style.display = 'none';
            document.getElementById('mensajeCarga').style.display = 'block';
            document.getElementById('mensajeSinDatos').style.display = 'none';

            try {
                const { data: inspecciones, error: inspError } = await supabase
                    .from('inspecciones')
                    .select('id')
                    .eq('estacion_id', estacionId);
                if (inspError) throw inspError;
                if (!inspecciones || inspecciones.length === 0) {
                    document.getElementById('mensajeCarga').style.display = 'none';
                    document.getElementById('mensajeSinDatos').style.display = 'block';
                    return;
                }

                const idsInspecciones = inspecciones.map(i => i.id);
                const { data: items, error: itemsError } = await supabase
                    .from('items_inspeccion')
                    .select('item_nombre, cumple, porcentaje_cumplimiento')
                    .in('inspeccion_id', idsInspecciones);
                if (itemsError) throw itemsError;
                if (!items || items.length === 0) {
                    document.getElementById('mensajeCarga').style.display = 'none';
                    document.getElementById('mensajeSinDatos').style.display = 'block';
                    return;
                }

                estadisticasTotales = calcularEstadisticas(items);
                totalPaginas = Math.ceil(todosLosItems.length / ITEMS_POR_PAGINA);
                paginaActual = 1;
                actualizarVista();

                document.getElementById('mensajeCarga').style.display = 'none';
                document.getElementById('resultadosContainer').style.display = 'block';
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('mensajeCarga').style.display = 'none';
                document.getElementById('mensajeSinDatos').textContent = 'Error al cargar datos.';
                document.getElementById('mensajeSinDatos').style.display = 'block';
            }
        }

        function calcularEstadisticas(items) {
            const resultado = {};
            todosLosItems.forEach(item => resultado[item] = 0);
            const agrupado = {};
            items.forEach(item => {
                if (item.cumple === true) {
                    if (!agrupado[item.item_nombre]) agrupado[item.item_nombre] = [];
                    agrupado[item.item_nombre].push(parseFloat(item.porcentaje_cumplimiento) || 0);
                }
            });
            Object.keys(agrupado).forEach(item => {
                const valores = agrupado[item];
                if (valores.length > 0) {
                    const promedio = valores.reduce((a, b) => a + b, 0) / valores.length;
                    resultado[item] = parseFloat(promedio.toFixed(1));
                }
            });
            return resultado;
        }

        function actualizarVista() {
            const inicio = (paginaActual - 1) * ITEMS_POR_PAGINA;
            const fin = inicio + ITEMS_POR_PAGINA;
            const itemsPagina = todosLosItems.slice(inicio, fin);
            renderizarGrafico(itemsPagina);
            renderizarTabla(itemsPagina);
            document.getElementById('paginaActual').textContent = `Página ${paginaActual}`;
            document.getElementById('btnAnterior').disabled = paginaActual === 1;
            document.getElementById('btnSiguiente').disabled = paginaActual === totalPaginas;
            document.getElementById('statsHeader').textContent = 
                `Estadísticas para: ${nombreEstacionActual} (Ítems ${(paginaActual - 1) * ITEMS_POR_PAGINA + 1}–${Math.min(paginaActual * ITEMS_POR_PAGINA, todosLosItems.length)} de ${todosLosItems.length})`;
        }

        function renderizarGrafico(itemsPagina) {
            const ctx = document.getElementById('cumplimientoChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            const labels = itemsPagina.map(k => nombresItems[k].split('.')[0]);
            const data = itemsPagina.map(k => estadisticasTotales[k] || 0);
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% de Cumplimiento Promedio',
                        data: data,
                        backgroundColor: 'rgba(49, 130, 206, 0.8)',
                        borderColor: 'rgba(49, 130, 206, 1)',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    const idx = (paginaActual - 1) * ITEMS_POR_PAGINA + ctx.dataIndex;
                                    return `${nombresItems[todosLosItems[idx]]}: ${ctx.parsed.x}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        function renderizarTabla(itemsPagina) {
            const tbody = document.getElementById('tablaItems');
            const filtro = document.getElementById('filtroItems').value.toLowerCase();
            tbody.innerHTML = '';
            itemsPagina.forEach(key => {
                const nombre = nombresItems[key];
                const porcentaje = estadisticasTotales[key] || 0;
                if (nombre.toLowerCase().includes(filtro)) {
                    const tr = document.createElement('tr');
                    let clase = porcentaje >= 80 ? 'alto' : porcentaje >= 50 ? 'medio' : 'bajo';
                    tr.innerHTML = `
                        <td>${nombre}</td>
                        <td class="porcentaje-valor ${clase}">${porcentaje}%</td>
                    `;
                    tbody.appendChild(tr);
                }
            });
        }

        document.getElementById('btnAnterior').addEventListener('click', () => {
            if (paginaActual > 1) {
                paginaActual--;
                actualizarVista();
            }
        });
        document.getElementById('btnSiguiente').addEventListener('click', () => {
            if (paginaActual < totalPaginas) {
                paginaActual++;
                actualizarVista();
            }
        });
        document.getElementById('filtroItems').addEventListener('input', () => {
            const inicio = (paginaActual - 1) * ITEMS_POR_PAGINA;
            const fin = inicio + ITEMS_POR_PAGINA;
            const itemsPagina = todosLosItems.slice(inicio, fin);
            renderizarTabla(itemsPagina);
        });

        function volverASeleccion() {
            document.getElementById('resultadosContainer').style.display = 'none';
            document.getElementById('mensajeSinDatos').style.display = 'none';
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
            document.getElementById('tablaItems').innerHTML = '';
            document.getElementById('filtroItems').value = '';
        }

        // === Cargar estaciones al iniciar ===
        cargarEstacionesCapital();
    </script>
</body>
</html>
